<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>á€á˜áŸ’á˜áœá·á’á¸á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á‚áŸ’ášá¿á„á¡á¶á“</title>
    <!-- Bootstrap 5 CDN for responsive design -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Font for proper Khmer rendering -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Khmer:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans Khmer', sans-serif; background-color: #f8f9fa; }
        .header { background-color: #0d6efd; color: white; padding: 1rem 0; }
        .stat-card { border: none; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .low-stock-row { background-color: #fff3cd !important; }
        .low-stock-alert { background-color: #f8d7da; border-color: #f5c2c7; }
        .table th { cursor: pointer; }
        .btn-export { margin-bottom: 1rem; }
    </style>
</head>
<body>
    <header class="header text-center">
        <h1 class="display-5 fw-bold">á€á˜áŸ’á˜áœá·á’á¸á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á‚áŸ’ášá¿á„á¡á¶á“ ğŸš—</h1>
    </header>

    <div class="container mt-4">
        <!-- Dashboard Statistics -->
        <div class="row g-4 mb-5">
            <div class="col-6 col-md-3">
                <div class="card stat-card text-center p-4 bg-primary text-white">
                    <h5>á‘áŸ†á“á·á‰áŸášá»á”</h5>
                    <h2 id="totalItems">0</h2>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card stat-card text-center p-4 bg-success text-white">
                    <h5>áá˜áŸ’á›áŸƒáŸášá»á” ($)</h5>
                    <h2 id="totalValue">0.00</h2>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card stat-card text-center p-4 bg-info text-white">
                    <h5>á”áŸ’ášá¶á€áŸ‹á…áŸ†ááŸá‰áŸášá»á” ($)</h5>
                    <h2 id="totalProfit">0.00</h2>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card stat-card text-center p-4 bg-warning text-dark">
                    <h5>á‚áŸ’ášá¿á„áŸáŸ’áá»á€á‘á¶á”</h5>
                    <h2 id="lowStockCount">0</h2>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs mb-4" id="appTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#stockTab" aria-selected="true">áŸáŸ’áá»á€á‘áŸ†á“á·á‰</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#addTab">á”á“áŸ’ááŸ‚á˜ / á€áŸ‚á‚áŸ’ášá¿á„</button>
            </li>
        </ul>

        <div class="tab-content">
            <!-- Stock List Tab -->
            <div class="tab-pane fade show active" id="stockTab">
                <div class="d-flex justify-content-between mb-3">
                    <input type="text" id="searchInput" class="form-control w-50" placeholder="áŸáŸ’áœáŸ‚á„ášá€áˆáŸ’á˜áŸ„áŸ‡á‚áŸ’ášá¿á„..." aria-label="áŸáŸ’áœáŸ‚á„ášá€">
                    <button class="btn btn-success btn-export" onclick="exportToCSV()">á“á¶áŸ†á…áŸá‰á‡á¶ CSV ğŸ“„</button>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover table-bordered align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th onclick="sortTable(0)">á›.áš</th>
                                <th onclick="sortTable(1)">áˆáŸ’á˜áŸ„áŸ‡á‚áŸ’ášá¿á„</th>
                                <th onclick="sortTable(2)">á”áŸ’ášá—áŸá‘</th>
                                <th onclick="sortTable(3)">á”ášá·á˜á¶á</th>
                                <th onclick="sortTable(4)">áá˜áŸ’á›áŸƒá›á€áŸ‹ ($)</th>
                                <th>áá˜áŸ’á›áŸƒáŸášá»á” ($)</th>
                                <th>áŸá€á˜áŸ’á˜á—á¶á–</th>
                            </tr>
                        </thead>
                        <tbody id="stockTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Add/Edit Item Tab -->
            <div class="tab-pane fade" id="addTab">
                <div class="card p-4">
                    <form id="itemForm">
                        <input type="hidden" id="editIndex">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">áˆáŸ’á˜áŸ„áŸ‡á‚áŸ’ášá¿á„ <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="itemName" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">á”áŸ’ášá—áŸá‘</label>
                                <select class="form-select" id="itemCategory">
                                    <option>á˜áŸ‰á¶áŸáŸŠá¸á“</option>
                                    <option>á áŸ’áœáŸ’ášá¶áŸ†á„</option>
                                    <option>á€á„áŸ‹ / áŸáŸ†á”á€á€á„áŸ‹</option>
                                    <option>á¢á‚áŸ’á‚á·áŸá“á¸</option>
                                    <option>áá½á¡á¶á“</option>
                                    <option>á•áŸ’áŸáŸá„áŸ—</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">á”ášá·á˜á¶á <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="itemQuantity" min="0" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">áá˜áŸ’á›áŸƒá›á€áŸ‹ ($) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="itemPrice" step="0.01" min="0" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">áá˜áŸ’á›áŸƒá‘á·á‰ ($)</label>
                                <input type="number" class="form-control" id="itemCost" step="0.01" min="0">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary mt-4">ášá€áŸ’áŸá¶á‘á»á€á‚áŸ’ášá¿á„</button>
                        <button type="reset" class="btn btn-secondary mt-4 ms-3" onclick="resetForm()">áŸá˜áŸ’á¢á¶á</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let inventory = JSON.parse(localStorage.getItem('autoPartsInventory')) || [];

        function renderTable(search = '') {
            const tbody = document.getElementById('stockTableBody');
            tbody.innerHTML = '';
            let lowCount = 0;
            const filtered = inventory.filter(item => item.name.toLowerCase().includes(search.toLowerCase()));

            filtered.forEach((item, idx) => {
                if (item.quantity < 10) lowCount++;
                const row = document.createElement('tr');
                if (item.quantity < 10) row.classList.add('low-stock-row');
                row.innerHTML = `
                    <td>${idx + 1}</td>
                    <td>${item.name}</td>
                    <td>${item.category}</td>
                    <td>${item.quantity}</td>
                    <td>${parseFloat(item.price).toFixed(2)}</td>
                    <td>${(item.price * item.quantity).toFixed(2)}</td>
                    <td>
                        <button class="btn btn-sm btn-warning me-2" onclick="editItem(${inventory.indexOf(item)})">á€áŸ‚ âœï¸</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteItem(${inventory.indexOf(item)})">á›á»á” ğŸ—‘ï¸</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            updateStats(lowCount);
        }

        function updateStats(lowCount = 0) {
            const totalQty = inventory.reduce((sum, i) => sum + i.quantity, 0);
            const totalVal = inventory.reduce((sum, i) => sum + i.price * i.quantity, 0);
            const totalProfit = inventory.reduce((sum, i) => sum + (i.price - (i.cost || 0)) * i.quantity, 0);
            document.getElementById('totalItems').textContent = totalQty;
            document.getElementById('totalValue').textContent = totalVal.toFixed(2);
            document.getElementById('totalProfit').textContent = totalProfit.toFixed(2);
            document.getElementById('lowStockCount').textContent = lowCount;
        }

        function resetForm() {
            document.getElementById('itemForm').reset();
            document.getElementById('editIndex').value = '';
        }

        document.getElementById('itemForm').addEventListener('submit', e => {
            e.preventDefault();
            const index = document.getElementById('editIndex').value;
            const item = {
                name: document.getElementById('itemName').value.trim(),
                category: document.getElementById('itemCategory').value,
                quantity: parseInt(document.getElementById('itemQuantity').value),
                price: parseFloat(document.getElementById('itemPrice').value),
                cost: parseFloat(document.getElementById('itemCost').value || 0)
            };
            if (index === '') {
                inventory.push(item);
            } else {
                inventory[parseInt(index)] = item;
            }
            localStorage.setItem('autoPartsInventory', JSON.stringify(inventory));
            renderTable(document.getElementById('searchInput').value);
            resetForm();
            // Switch to stock tab after save
            new bootstrap.Tab(document.querySelector('[data-bs-target="#stockTab"]')).show();
        });

        function editItem(idx) {
            const item = inventory[idx];
            document.getElementById('editIndex').value = idx;
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemCategory').value = item.category;
            document.getElementById('itemQuantity').value = item.quantity;
            document.getElementById('itemPrice').value = item.price;
            document.getElementById('itemCost').value = item.cost || '';
            new bootstrap.Tab(document.querySelector('[data-bs-target="#addTab"]')).show();
        }

        function deleteItem(idx) {
            if (confirm('áá¾á¢áŸ’á“á€á”áŸ’ášá¶á€áŠá‡á¶á…á„áŸ‹á›á»á”á‚áŸ’ášá¿á„á“áŸáŸ‡á˜áŸ‚á“á‘áŸ?')) {
                inventory.splice(idx, 1);
                localStorage.setItem('autoPartsInventory', JSON.stringify(inventory));
                renderTable(document.getElementById('searchInput').value);
            }
        }

        function exportToCSV() {
            let csv = 'á›.áš,áˆáŸ’á˜áŸ„áŸ‡á‚áŸ’ášá¿á„,á”áŸ’ášá—áŸá‘,á”ášá·á˜á¶á,áá˜áŸ’á›áŸƒá›á€áŸ‹,áá˜áŸ’á›áŸƒá‘á·á‰,áá˜áŸ’á›áŸƒáŸášá»á”\n';
            inventory.forEach((item, i) => {
                csv += `${i+1},${item.name},${item.category},${item.quantity},${item.price},${item.cost || 0},${(item.price * item.quantity).toFixed(2)}\n`;
            });
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'á‚áŸ’ášá¿á„á¡á¶á“_áŸáŸ’áá»á€.csv';
            link.click();
        }

        // Basic sorting (click header)
        let sortDirection = {};
        function sortTable(colIdx) {
            const keyMap = ['name', 'name', 'category', 'quantity', 'price'];
            if (colIdx < 5) {
                const key = keyMap[colIdx];
                sortDirection[key] = (sortDirection[key] || 1) * -1;
                inventory.sort((a, b) => {
                    if (typeof a[key] === 'string') return a[key].localeCompare(b[key]) * sortDirection[key];
                    return (a[key] - b[key]) * sortDirection[key];
                });
                renderTable(document.getElementById('searchInput').value);
            }
        }

        // Search listener
        document.getElementById('searchInput').addEventListener('input', e => renderTable(e.target.value));

        // Initial render
        renderTable();
    </script>
</body>
</html>
