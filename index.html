<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>កម្មវិធីគ្រប់គ្រងគ្រឿងឡាន</title>
    
    <!-- Favicons -->
    <link rel="apple-touch-icon" sizes="180x180" href="/Test-app/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/Test-app/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/Test-app/favicon-16x16.png">
    <link rel="manifest" href="/Test-app/site.webmanifest">
    <link rel="mask-icon" href="/Test-app/safari-pinned-tab.svg" color="#0f2027">
    <link rel="shortcut icon" href="/Test-app/favicon.ico">
    <meta name="msapplication-TileColor" content="#0f2027">
    <meta name="msapplication-config" content="/Test-app/browserconfig.xml">
    <meta name="theme-color" content="#0f2027">
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Parts Manager">
    <!-- CSS & Fonts -->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Vue.js -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- QRCode library with multiple fallbacks -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script>
        // If first CDN fails, try another
        if (typeof QRCode === 'undefined') {
            console.log('First QRCode failed, trying fallback...');
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/qrcode@1.5.0/build/qrcode.min.js';
            script.onload = function() {
                console.log('QRCode loaded from fallback');
            };
            script.onerror = function() {
                console.error('All QRCode CDNs failed');
            };
            document.head.appendChild(script);
        } else {
            console.log('QRCode loaded successfully');
        }
    </script>
</head>
<body>
    <div id="app">
        <!-- Header & Theme Toggle -->
        <div class="header">
            <h1><i class="fas fa-car"></i> កម្មវិធីគ្រប់គ្រងគ្រឿងឡាន</h1>
            <div class="theme-toggle">
                <label>
                    <input type="checkbox" v-model="isLightMode" @change="toggleTheme">
                    <span>{{ isLightMode ? '🌙 ផ្ទាំងងងឹត' : '☀️ ផ្ទាំងភ្លឺ' }}</span>
                </label>
            </div>
             <div class="install-btn" v-if="showInstallBtn" @click="installPWA">
             <i class="fas fa-download"></i> ដំឡើងកម្មវិធី
             </div>
        </div>

        <div class="container">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab" :class="{ active: activeTab === 'add' }" @click="activeTab = 'add'">
                    <i class="fas fa-plus"></i> បន្ថែមគ្រឿង
                </button>
                <button class="tab" :class="{ active: activeTab === 'stock' }" @click="activeTab = 'stock'">
                    <i class="fas fa-boxes"></i> ស្តុកគ្រឿង
                </button>
                <button class="tab" :class="{ active: activeTab === 'stats' }" @click="activeTab = 'stats'">
                    <i class="fas fa-chart-bar"></i> ស្ថិតិ
                </button>
                 <button class="tab" :class="{ active: activeTab === 'bulk' }" @click="activeTab = 'bulk'">
                     <i class="fas fa-upload"></i> នាំចូល/ចេញ
                 </button>
            </div>

            <!-- Add Part Tab -->
            <div v-if="activeTab === 'add'" class="tab-content active">
                <div class="form-card">
                    <form @submit.prevent="saveItem">
                        <div class="form-row">
                            <div>
                                <label for="company"><i class="fas fa-building"></i> ក្រុមហ៊ុន</label>
                                <input type="text" id="company" v-model="form.company" required>
                            </div>
                            <div>
                                <label for="productCode"><i class="fas fa-barcode"></i> កូដគ្រឿង</label>
                                <input type="text" id="productCode" v-model="form.productCode" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div>
                                <label for="partName"><i class="fas fa-cog"></i> ឈ្មោះគ្រឿង</label>
                                <input type="text" id="partName" v-model="form.partName" required>
                            </div>
                            <div>
                                <label for="carModel"><i class="fas fa-car-side"></i> ម៉ូដែលឡាន</label>
                                <input type="text" id="carModel" v-model="form.carModel" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div>
                                <label for="modelYear"><i class="fas fa-calendar-alt"></i> ឆ្នាំម៉ូដែល</label>
                                <input type="text" id="modelYear" v-model="form.modelYear" required>
                            </div>
                            <div>
                                <label for="quantity"><i class="fas fa-box"></i> ចំនួន</label>
                                <input type="number" id="quantity" v-model="form.quantity" min="1" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div>
                                <label for="buyPrice"><i class="fas fa-dollar-sign"></i> តម្លៃទិញ ($)</label>
                                <input type="number" id="buyPrice" v-model="form.buyPrice" step="0.01" min="0" required>
                            </div>
                            <div>
                                <label for="sellPrice"><i class="fas fa-tag"></i> តម្លៃលក់ ($)</label>
                                <input type="number" id="sellPrice" v-model="form.sellPrice" step="0.01" min="0" required>
                            </div>
                        </div>
                        <button type="submit" class="btn">
                            <i class="fas fa-save"></i> រក្សាទុកគ្រឿង
                        </button>
                    </form>
                </div>
            </div>

            <!-- Stock Tab -->
            <div v-if="activeTab === 'stock'" class="tab-content active">
                <div class="search-box">
                    <input type="text" v-model="searchQuery" placeholder="ស្វែងរកគ្រឿង...">
                </div>
                      <!-- Add this after the search box in Stock tab -->
                <div class="filter-section">
                <div class="filter-row">
                <select v-model="selectedCompany" @change="applyFilters">
                <option value="">គ្រប់ក្រុមហ៊ុន</option>
                <option v-for="company in uniqueCompanies" :value="company">{{ company }}</option>
                </select>
        
                <select v-model="selectedCarModel" @change="applyFilters">
                <option value="">គ្រប់ម៉ូដែលឡាន</option>
                <option v-for="model in uniqueCarModels" :value="model">{{ model }}</option>
                </select>
        
                <select v-model="selectedYear" @change="applyFilters">
            <option value="">គ្រប់ឆ្នាំម៉ូដែល</option>
            <option v-for="year in uniqueYears" :value="year">{{ year }}</option>
        </select>
        
        <button class="clear-filters" @click="clearFilters">
            <i class="fas fa-times"></i> លុបតម្រង
        </button>
    </div>
    
    <!-- Active Filters Display -->
    <div v-if="hasActiveFilters" class="active-filters">
        <span class="filter-tag" v-if="selectedCompany">
            ក្រុមហ៊ុន: {{ selectedCompany }}
            <span @click="selectedCompany = ''">×</span>
        </span>
        <span class="filter-tag" v-if="selectedCarModel">
            ម៉ូដែល: {{ selectedCarModel }}
            <span @click="selectedCarModel = ''">×</span>
        </span>
        <span class="filter-tag" v-if="selectedYear">
            ឆ្នាំ: {{ selectedYear }}
            <span @click="selectedYear = ''">×</span>
        </span>
    </div>
</div>
                <div class="inventory-list">
                    <div v-for="item in filteredInventory" :key="item.id" class="inventory-item">
                        <div class="item-top">
                            <div class="item-left">
                                <div class="item-name">{{ item.partName }}</div>
                                <div class="item-code">កូដ: {{ item.productCode }} | ក្រុមហ៊ុន: {{ item.company }}</div>
                                <div class="detail-row">
                                    <span class="detail-chip">{{ item.carModel }}</span>
                                    <span class="detail-chip year">{{ item.modelYear }}</span>
                                    <span class="detail-chip" :class="{ 'low-stock': item.quantity <= 2 }">
                                        <i class="fas fa-box"></i> {{ item.quantity }}
                                    </span>
                                </div>
                                <div class="detail-company">
                                    <i class="fas fa-building"></i> {{ item.company }}
                                </div>
                            </div>
                        </div>
                        <div class="price-section">
                            <div class="price-value buy">
                                <div>ទិញ</div>
                                <div>${{ item.buyPrice.toFixed(2) }}</div>
                            </div>
                            <div class="price-value sell">
                                <div>លក់</div>
                                <div>${{ item.sellPrice.toFixed(2) }}</div>
                            </div>
                            <div class="price-value profit">
                                <div>ចំណេញ</div>
                                <div>${{ (item.sellPrice - item.buyPrice).toFixed(2) }}</div>
                            </div>
                        </div>
                        <div class="actions">
                            <button class="edit" @click="openEdit(item.id)">
                                <i class="fas fa-edit"></i> កែ
                            </button>
                            <button class="delete" @click="deleteItem(item.id)">
                                <i class="fas fa-trash"></i> លុប
                            </button>
                            <div class="qr-section">
                                <button class="qr-btn" @click="generateQR(item)">
                                    <i class="fas fa-qrcode"></i> QR
                                </button>
                           </div>
                        </div>
                    </div>
                </div>
                <button class="btn export-btn" @click="exportToCSV">
                    <i class="fas fa-file-export"></i> នាំចេញជា CSV
                </button>
            </div>

            <!-- Statistics Tab -->
            <div v-if="activeTab === 'stats'" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">ទំនិញសរុប</div>
                        <div class="stat-value">{{ totalItems }}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">តម្លៃទិញសរុប</div>
                        <div class="stat-value">${{ totalCost.toFixed(2) }}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ប្រាក់ចំណេញសរុប</div>
                        <div class="stat-value">${{ totalProfit.toFixed(2) }}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">គ្រឿងស្តុកទាប</div>
                        <div class="stat-value">{{ lowStockCount }}</div>
                    </div>
                </div>
            </div>
        
            <!-- Bulk Operations Tab -->
            <div v-if="activeTab === 'bulk'" class="tab-content active">
                <div class="bulk-actions">
                    <h3><i class="fas fa-file-import"></i> នាំចូលគ្រឿងពីឯកសារ CSV</h3>
                    <p>អាចនាំចូលគ្រឿងច្រើនក្នុងពេលតែមួយដោយប្រើឯកសារ CSV</p>
        
                    <label class="file-label" for="csvFile">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <div>ចុចដើម្បីជ្រើសរើសឯកសារ CSV</div>
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">ឬទាញឯកសារទម្លាក់នៅទីនេះ</div>
                    </label>
                    <input type="file" id="csvFile" class="file-input" accept=".csv" @change="handleImport">
        
                    <div class="bulk-buttons">
                        <button class="bulk-btn template-btn" @click="downloadTemplate">
                            <i class="fas fa-file-download"></i> ទាញយកគំរូ
                        </button>
                        <button class="bulk-btn export-btn-bulk" @click="exportAllToCSV">
                            <i class="fas fa-file-export"></i> នាំចេញទាំងអស់
                        </button>
                    </div>
        
                    <div v-if="importResults" class="import-results">
                        <h4><i class="fas fa-clipboard-check"></i> លទ្ធផលនាំចូល</h4>
                        <p class="result-success">បានដាក់ចូលដោយជោគជ័យ: {{ importResults.success }}/{{ importResults.total }}</p>
                        <p v-if="importResults.errors.length" class="result-error">
                            មានកំហុស: {{ importResults.errors.length }}
                        </p>
                        <div v-for="(error, idx) in importResults.errors" :key="idx" class="result-warning">
                            {{ error }}
                        </div>
                        <button @click="importResults = null" style="margin-top: 10px;">
                            <i class="fas fa-times"></i> លុបលទ្ធផល
                        </button>
                    </div>
                </div>
    
                <div class="form-card">
                    <h3><i class="fas fa-info-circle"></i> សេចក្តីណែនាំ</h3>
                    <ol style="margin-left: 20px; margin-top: 10px;">
                        <li>ទាញយកឯកសារគំរូដោយចុចប៊ូតុង "ទាញយកគំរូ"</li>
                        <li>បំពេញព័ត៌មានគ្រឿងទំនិញក្នុងឯកសារ CSV</li>
                        <li>ជ្រើសរើសឯកសារដោយចុចត្រង់ផ្ទៃពណ៌ប្រផេះ</li>
                        <li>គ្រឿងនឹងត្រូវបានដាក់ចូលដោយស្វ័យប្រវត្តិ</li>
                    </ol>
                    <p style="margin-top: 15px; font-style: italic;">
                        <i class="fas fa-lightbulb"></i> ព័ត៌មាន: ប្រសិនបើកូដគ្រឿងមានរួចហើយ វានឹងកែប្រែទិន្នន័យចាស់
                    </p>
                </div>
            </div>
        </div> <!-- End of .container -->

        <!-- Duplicate Modal -->
        <div v-if="showDuplicateModal" class="modal active">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-exclamation-triangle"></i> កូដគ្រឿង "{{ duplicateItem?.productCode }}" មានរួចហើយ!</h2>
                    <button class="close-btn" @click="closeDuplicateModal">&times;</button>
                </div>
                <p>តើអ្នកចង់បន្ថែមជាទំនិញថ្មី ឬកែប្រែទំនិញចាស់?</p>
                <div class="modal-buttons">
                    <button class="modal-btn-add" @click="addAsNew">
                        <i class="fas fa-plus"></i> បន្ថែមថ្មី
                    </button>
                    <button class="modal-btn-edit" @click="editExisting">
                        <i class="fas fa-edit"></i> កែប្រែចាស់
                    </button>
                    <button class="modal-btn-cancel" @click="closeDuplicateModal">
                        <i class="fas fa-times"></i> បោះបង់
                    </button>
                </div>
            </div>
        </div>

        <!-- Edit Modal -->
        <div v-if="showEditModal" class="modal active">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-edit"></i> កែប្រែគ្រឿង</h2>
                    <button class="close-btn" @click="closeEditModal">&times;</button>
                </div>
                <form @submit.prevent="updateItem">
                    <input type="hidden" v-model="editForm.id">
                    <div class="form-row">
                        <div>
                            <label>ក្រុមហ៊ុន</label>
                            <input type="text" v-model="editForm.company" required>
                        </div>
                        <div>
                            <label>កូដគ្រឿង</label>
                            <input type="text" v-model="editForm.productCode" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div>
                            <label>ឈ្មោះគ្រឿង</label>
                            <input type="text" v-model="editForm.partName" required>
                        </div>
                        <div>
                            <label>ម៉ូដែលឡាន</label>
                            <input type="text" v-model="editForm.carModel" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div>
                            <label>ឆ្នាំម៉ូដែល</label>
                            <input type="text" v-model="editForm.modelYear" required>
                        </div>
                        <div>
                            <label>ចំនួន</label>
                            <input type="number" v-model="editForm.quantity" min="1" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div>
                            <label>តម្លៃទិញ ($)</label>
                            <input type="number" v-model="editForm.buyPrice" step="0.01" min="0" required>
                        </div>
                        <div>
                            <label>តម្លៃលក់ ($)</label>
                            <input type="number" v-model="editForm.sellPrice" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="modal-buttons">
                        <button type="submit" class="modal-btn-add">
                            <i class="fas fa-save"></i> រក្សាទុក
                        </button>
                        <button type="button" class="modal-btn-cancel" @click="closeEditModal">
                            <i class="fas fa-times"></i> បោះបង់
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- QR Modal -->
<div v-if="showQRModal" class="modal active">
    <div class="modal-content qr-modal">
        <div class="modal-header">
            <h2><i class="fas fa-qrcode"></i> QR Code for {{ qrItem.partName }}</h2>
            <button class="close-btn" @click="closeQRModal">&times;</button>
        </div>
        <div class="qr-container">
            <div class="qr-code">
                <!-- QR will be generated here -->
            </div>
            <div class="qr-info">
                <p><strong>ឈ្មោះគ្រឿង:</strong> {{ qrItem.partName }}</p>
                <p><strong>កូដ:</strong> {{ qrItem.productCode }}</p>
                <p><strong>ឡាន:</strong> {{ qrItem.carModel }} ({{ qrItem.modelYear }})</p>
                <p><strong>តម្លៃលក់:</strong> ${{ qrItem.sellPrice.toFixed(2) }}</p>
                <p><strong>ស្តុក:</strong> {{ qrItem.quantity }}</p>
                <p><strong>ក្រុមហ៊ុន:</strong> {{ qrItem.company }}</p>
            </div>
        </div>
        <div class="modal-buttons">
            <button class="modal-btn-add" @click="downloadQR">
                <i class="fas fa-download"></i> ទាញយក
            </button>
            <button class="modal-btn-edit" @click="printQR">
                <i class="fas fa-print"></i> បោះពុម្ព
            </button>
            <button class="modal-btn-cancel" @click="closeQRModal">
                <i class="fas fa-times"></i> បិទ
            </button>
        </div>
    </div>
</div>

    </div> <!-- End of #app -->

    <script src="script.js"></script>
    <script>
        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/Test-app/service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered:', registration);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }

        // Detect if app is installed
        window.addEventListener('beforeinstallprompt', (e) => {
            // Show install button if not already installed
            if (!window.matchMedia('(display-mode: standalone)').matches) {
                setTimeout(() => {
                    if (confirm('ចង់ដំឡើងកម្មវិធីនេះនៅលើឧបករណ៍របស់អ្នកទេ?')) {
                        e.prompt();
                    }
                }, 3000);
            }
        });
    </script>
</body>
</html>
